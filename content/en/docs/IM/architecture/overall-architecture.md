---
title: "IM系统总体架构"
linkTitle: "IM系统总体架构"
date: 2021-11-07
weight: 202111072207
---

> **简介：** 前言 IM全称是『Instant Messaging』，中文名是即时通讯。在这个高度信息化的移动互联网时代，生活中IM类产品已经成为必备品，比较有名的如钉钉、微信、QQ等以IM为核心功能的产品。当然目前微信已经成长为一个生态型产品，但其核心功能还是IM。

### 1. 前言

IM全称是『Instant Messaging』，中文名是即时通讯。在这个高度信息化的移动互联网时代，生活中IM类产品已经成为必备品，比较有名的如钉钉、微信、QQ等以IM为核心功能的产品。当然目前微信已经成长为一个生态型产品，但其核心功能还是IM。还有一些非以IM系统为核心的应用，最典型的如一些在线游戏、社交应用，IM也是其重要的功能模块。可以说，IM系统已经是任何一个带有社交属性的应用需要具备的基础功能，网络上对于这类系统的设计与实现的讨论也越来越多。

IM系统在互联网初期即存在，其基础技术架构在这十几年的发展中更新迭代多次，从早期的CS、P2P架构，到现在后台已经演变为一个复杂的分布式系统，涉及移动端、网络通信、协议、安全、存储和搜索等技术的方方面面。IM系统中最核心的部分是消息系统，消息系统中最核心的功能是消息的同步、存储和检索：

- **消息的同步**：将消息完整的、快速的从发送方传递到接收方，就是消息的同步。消息同步系统最重要的衡量指标就是消息传递的实时性、完整性以及能支撑的消息规模。从功能上来说，一般至少要支持在线和离线推送，高级的IM系统还支持『多端同步』。
- **消息的存储**：消息存储即消息的持久化保存，传统消息系统通常只能支持消息在接收端的本地存储，数据基本不具备可靠性。现代消息系统能支持消息在服务端的在线存储，功能上对应的就是『消息漫游』，消息漫游的好处是可以实现账号在任意端登陆查看所有历史消息。(微信说是服务器不存储用户的聊天数据，而QQ是可以通过开通会员来实现消息漫游将消息存在云端。对于钉钉是提供有限时间的消息漫游，好像是可以拉取一年的消息)
- **消息的检索**：消息一般是文本，所以支持全文检索也是必备的能力之一。传统消息系统通常来说也是只能支持消息的本地检索，基于本地存储的消息数据来构建。而现在消息系统在能支持消息的在线存储后，也具备了消息的『在线检索』能力。

> PS: 当时给公司做的IM系统也是不支持消息漫游，只是将未读的消息进行了七天保存到ETCD中。超过七天的消息会自动过期，反正坑太多。都是泪不说了！

### 2. 技术架构

![IM技术架构图](https://raw.githubusercontent.com/mxsm/picture/main/IM/IM%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E5%9B%BE.png)

IM架构主要分为六个部分，如上图所示：

- **Register: ** 注册中心，注册中心与注册中心之间没有联系，已单例模式构建集群。这样的好处就是实现简单，通过多个单例达到高可用。
- **Client:** 主要负责消息的收发，从注册中心(Register)获取合适的 **MagpieBridge** 地址进行链接，根据配置的策略进行获取。客户端支持限流
- **MagpieBridge：** 负责客户端的接入，服务启动会往注册中心注册**`MagpieBridge`** 的元数据。同时定时向注册中心发送**`MagpieBridge`** 接入的客户端数据信息。
- **MessageHandlerService：** 负责处理客户端发送过来的消息，转发消息给对应的接收人，同时将消息持久化到数据库。提供数据持久化服务 以及历史数据查询和消息处理服务
- **Cassandra：** 消息存储数据库，负责用户数据的存储
- **Metric：** 系统的服务监控指标获取

### 3. 注册中心(Register)

注册中心(Register)可以实现线性拓展。

注册中心主要有两个功能：

1. 提供MagpieBridge和MessageHandlerService的服务注册发现
2. Client连接MagpieBridge的时候会从注册中心选取对应的MagpieBridge地址进行接入。同时为metric提供统计数据支持。

注册中心的集群由单个注册中心组成。当一个注册中心出现问题，客户端可以从其他的注册中心获取客户端的接入服务 **MagpieBridge** 来接入消息的连接。注册中心同时会同步 **MagpieBridge** 本身的相关在线状态信息以及接入的客户端的信息。也包含消息处理服务 **MessageHandlerService** 在线服务信息。

### 4. 客户端接入服务（MagpieBridge）

MagpieBridge允许线性拓展，服务于服务之间没有联系。可以单独进行部署。客户端接入后会记录客户端的一些基本信息，同时会定时将客户端的信息同步到注册中心的每个节点便于后续新接入的客户端选择接入点的策略同时给**Metric** 服务提供检测数据。

### 5.消息处理服务(MessageHandlerService)

消息处理服务(MessageHandlerService)允许线性拓展，服务上线就需要将服务的信息同步到注册中心以及链接到消息处理服务的客户端接入服务的信息。

### 6. Cassandra

负责消息存储

### 7. Metric

主要负责提供监控数据的展示
