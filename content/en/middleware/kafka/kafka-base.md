---
title: kafka基本知识
linkTitle: kafka基本知识
date: 2018-03-09
---
### 1. 什么是主题和分区？

- **主题**

  主题好比数据库的表或者文件系统里面的文件夹

- **分区**

  分区好比数据库表的分表，或者文件夹中存放数据的子文件夹

**注意：**

```
一个主题包含多个分区1对N的情况，因此无法在整个个主题范围内保证消息的有序，但是可以保证单个分区内的消息顺序。因
为一个分区是一个类似FIFO的队列，然后先入的先出读取数据。
kafka通过分区来实现数据冗余和伸缩。分区可以分别在不同的机器上，一个主题可以横跨多个服务器。
```

![图解](https://github.com/mxsm/document/blob/master/image/MQ/Kafka/kafka-topic%E5%92%8C%E5%88%86%E5%8C%BA%E7%9A%84%E5%85%B3%E7%B3%BB%E5%9B%BE.png?raw=true)

### 2 生产者和消费者

- **生产者**

  创建消息，一般情况下，一个消息会发布到一个特定的主题上面，生产者默认的情况下把消息均衡的分配到主题的分区上面，而并不关系特定的消息会被写到哪个分区。**如果需要把消息直接写到指定的分区，这通常是通过消息键和分区器来实现的，分区器为键生成一个散列值，并将其映射到指定的分区上。生产者也可以使用自定义的分区器。**

- **消费者**

  消费者订阅一个或者多个主题，并且按照生产的顺序读取，消费者通过检查消息的偏移量来区分已读过的消息。偏移量是另一种元数据，kafka会把它添加到消息里面。在给定的分区里，每一个消息偏移量都是唯一的。消费者会把每个分区的偏移量量保存到zookeeper或者kafka。消费者关闭或者重启，状态不会丢失

  消费者是**消费者组的一部分** 也就是说会有一个消费者多个消费者读取共同的主题。群组保证每个分区只能被一个消费者使用。但是一个消费者可以消费多个分区

### 3 broker和集群

一个独立的 **`kafka`** 服务器被称为一个 **`broker`** 。接收来自生产者的消息，为消息设置偏移量，提交并且保存到磁盘上面。

**`broker`** 是群组的一部分。每个集群都要一个 **`broker`** 同时充当了**集群的控制器**的角色。 控制器负责管理工作，包括将分区分配给 **`broker`** 和监控 **`broker`** 。在集群中一个分区从属于一个 **`broker`** ,该 **broker** 被称为分区的**首领**。一个分区可以分配给多个 **`broker`** 这个时候会发生分区复制

![图](https://github.com/mxsm/document/blob/master/image/MQ/Kafka/kafka%E9%9B%86%E7%BE%A4%E5%88%86%E5%8C%BA%E5%A4%8D%E5%88%B6.png?raw=true)

### 4 控制器

控制器其实就是一个 **`broker`** ,集群里第一个启动的 broker 通过在**`zookeeper`** 创建临时节点让自己成为控制器。其他 **`broker`** 创建的发现节点已经存在说明集群中已经有一个控制齐了。

**控制的功能：**

- 发现 **`broker`** 离开集群(通过watch zookeeper路径)。控制器就知道哪些失去首领的分区需要一个新的首领。选举新的首领。
- 发现有新的 **`broker`** 加入集群，它会使用 **`broker ID`** 来检查新加入的 **`broker`** 是否包含现有分区的副本。如果有通知发送给新加入的 **`broker`** 和其他的 **`broker`** , 新的 **`broker`** 上的副本开始从首领那里复制消息。

控制器负责在节点加入或离开集群时进行分区首领选举

### 5 复制

消息的复制是 **`Kafka`** 的架构核心

**分区副本分为两种：**

- **Leader副本**

  每个分区都有一个首领副本 。 为了保证一致性，**所有生产者请求和消费者请求都会经过**。

- **Follower副本**

  首领 以外的副本都是跟随者副本。跟随者副本不处理来自客户端的请求，它们唯 一 的任务就是**从首领那里复制消息，保持与首领一致的状态**。如果首领发生崩渍，其中的一个跟随者会被提升为新首领。(**崩溃发生通过Follower副本进行处理**)

**Kafka处理请求的内部处理流程：**

![图](https://github.com/mxsm/document/blob/master/image/MQ/Kafka/kafka%E8%AF%B7%E6%B1%82%E7%9A%84%E5%86%85%E9%83%A8%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91.jpg?raw=true)

每个 **`Broker`** 都保存了所有的主题信息、分区、副本信息、以及副本首领等等。